# PRF - Plano de Requisi√ß√£o de Funcionalidade

## T√≠tulo
Refatora√ß√£o, Seguran√ßa e Finaliza√ß√£o de Funcionalidades do Sistema Escolar

---

## Objetivo
Consolidar e finalizar as principais funcionalidades do sistema escolar, garantindo seguran√ßa, modularidade, facilidade de manuten√ß√£o e experi√™ncia do usu√°rio, com foco em:

- Seguran√ßa de credenciais e regras do banco
- Finaliza√ß√£o do fluxo de exclus√£o de usu√°rios (Auth + DB)
- Refatora√ß√£o de componentes grandes para subcomponentes reutiliz√°veis
- Regras de neg√≥cio para per√≠odos escolares
- Melhoria de UX e feedbacks
- Estrutura√ß√£o para testes e auditoria

---

## Escopo

### 1. Seguran√ßa
- Remover arquivo de service account do reposit√≥rio e adicionar ao `.gitignore`
- Revisar e refor√ßar regras do Realtime Database
- Orientar uso seguro de credenciais em produ√ß√£o

### 2. Cloud Functions
- Recriar pasta `functions/` em TypeScript
- Adicionar fun√ß√£o `deleteUser` (exclus√£o Auth + DB)
- Ajustar scripts de lint/predeploy para deploy sem erros

### 3. Gest√£o Escolar
- Refatorar `escola/page.jsx` em subcomponentes: TurmaList, PeriodoManager, AvisosBoard, etc.
- Garantir unicidade de per√≠odo ativo por ano (se aplic√°vel)
- Impedir exclus√£o de per√≠odo vinculado a turma
- Exibir status de uso de per√≠odos

### 4. Experi√™ncia do Usu√°rio
- Substituir `alert` por toasts/snackbars
- Adicionar feedback visual em bot√µes (loading, sucesso, erro)
- Confirma√ß√£o ao editar/excluir dados sens√≠veis

### 5. Auditoria e Testes
- Adicionar campos `createdAt`, `updatedAt`, `createdBy` em entidades principais
- Estruturar diret√≥rio `services/` para l√≥gica de acesso ao banco
- Iniciar testes unit√°rios de helpers e servi√ßos

---

## Crit√©rios de Aceite
- Nenhum arquivo de credencial sens√≠vel no reposit√≥rio
- Exclus√£o de usu√°rio remove do Auth e do DB via fun√ß√£o backend
- N√£o √© poss√≠vel excluir per√≠odo vinculado a turma
- Refatora√ß√£o modular de pelo menos 2 grandes componentes
- Feedback visual em todas as a√ß√µes cr√≠ticas
- Regras do banco impedem escrita/leitura n√£o autorizada
- Teste unit√°rio b√°sico rodando para pelo menos um helper

---

## Prioridade
1. Seguran√ßa e Cloud Functions
2. Refatora√ß√£o modular e regras de neg√≥cio
3. UX e feedbacks
4. Auditoria e testes

---

## Observa√ß√µes
- O projeto j√° possui boa base de autentica√ß√£o, navega√ß√£o e CRUDs.
- A modulariza√ß√£o e seguran√ßa s√£o essenciais para escalar e manter o sistema.
- O roadmap pode ser ajustado conforme surgirem novas demandas.

---

# An√°lise de Funcionalidades e Melhorias para o Sistema Escolar

## Funcionalidades j√° implementadas

- **Gest√£o de Alunos**
  - Cadastro, edi√ß√£o e exclus√£o de alunos
  - Formul√°rio multi-etapas (dados pessoais, financeiros, anexos)
  - Upload e gerenciamento de anexos/documentos dos alunos
  - Visualiza√ß√£o e marca√ß√£o para exclus√£o de anexos
  - Filtros por turma, nome e matr√≠cula

- **Gest√£o de Turmas**
  - Cadastro e vincula√ß√£o de alunos a turmas
  - Visualiza√ß√£o de turmas

- **Gest√£o Financeira**
  - Controle de status financeiro do aluno (ativo/inadimplente)
  - Campos para valor de mensalidade, desconto, vencimento

- **Gest√£o de Usu√°rios do Sistema**
  - Cadastro, edi√ß√£o e exclus√£o de usu√°rios (coordenadora, professora, pai, inativo)
  - Aprova√ß√£o de novos usu√°rios
  - Filtro por tipo e por nome

- **Controle de Acesso**
  - Diferencia√ß√£o de permiss√µes por perfil (coordenadora, professora, pai)
  - Tela de acesso restrito

- **Alertas e Feedback Visual**
  - Mensagens de erro e alerta bem destacadas
  - Feedback visual para a√ß√µes importantes

---

## O que falta ou pode ser melhorado para uso real em escola

1. **Gest√£o de Professores e Funcion√°rios**
   - Cadastro e gerenciamento de professores e outros funcion√°rios
   - Vincula√ß√£o de professores a turmas e disciplinas

2. **Gest√£o de Disciplinas e Hor√°rios**
   - Cadastro de disciplinas/mat√©rias
   - Montagem de hor√°rios de aulas por turma e professor

3. **Lan√ßamento e Consulta de Notas/Frequ√™ncia**
   - Lan√ßamento de notas e faltas por disciplina
   - Consulta de boletim pelo respons√°vel/aluno

4. **Comunica√ß√£o Escola-Fam√≠lia**
   - Envio de avisos, comunicados e mensagens para respons√°veis
   - Hist√≥rico de comunicados

5. **Gest√£o de Matr√≠culas e Rematr√≠culas**
   - Processo de matr√≠cula e rematr√≠cula online
   - Controle de vagas por turma

6. **Relat√≥rios e Exporta√ß√µes**
   - Relat√≥rios de alunos por turma, inadimplentes, frequ√™ncia, notas etc.
   - Exporta√ß√£o para PDF/Excel

7. **Aprimoramento da Experi√™ncia do Usu√°rio**
   - Melhorias de usabilidade e acessibilidade
   - Layout responsivo para uso em celular/tablet
   - Ajuda/contexto para usu√°rios leigos

8. **Seguran√ßa e Auditoria**
   - Logs de a√ß√µes importantes (quem fez o qu√™ e quando)
   - Permiss√µes mais granulares (ex: s√≥ coordenadora pode excluir aluno)

9. **Integra√ß√£o com Pagamentos**
   - Integra√ß√£o com sistemas de cobran√ßa/boleto/pagamento online

10. **Backup e Recupera√ß√£o**
   - Rotina de backup autom√°tico dos dados

---

Essas melhorias s√£o recomendadas para tornar o sistema mais completo, seguro e pr√°tico para o dia a dia escolar.

---

# üí∞ An√°lise Completa do Sistema Financeiro

## üìä Situa√ß√£o Atual

### ‚úÖ Funcionalidades J√° Implementadas
- **Dados Financeiros B√°sicos do Aluno**:
  - `mensalidadeValor`: Valor da mensalidade
  - `descontoPercentual`: Percentual de desconto aplicado
  - `diaVencimento`: Dia do m√™s para vencimento (1-31)
  - `status`: Estado financeiro (`ativo`, `inadimplente`, `suspenso`)
  - `observacoes`: Campo livre para anota√ß√µes
  - C√°lculo autom√°tico do valor final com desconto

- **Valida√ß√µes Existentes**:
  - Dia de vencimento entre 1 e 31
  - Valor da mensalidade obrigat√≥rio
  - Status obrigat√≥rio
  - N√£o permite inativar aluno inadimplente

### ‚ùå Limita√ß√µes Atuais
- N√£o h√° gera√ß√£o de t√≠tulos/boletos
- N√£o h√° controle de pagamentos realizados
- N√£o h√° hist√≥rico financeiro
- N√£o h√° processo de matr√≠cula estruturado
- N√£o h√° controle de pr√©-matr√≠cula
- N√£o h√° relat√≥rios financeiros
- N√£o h√° integra√ß√£o com sistemas de pagamento

---

## üéØ Sistema Financeiro Completo - Especifica√ß√£o

### 1. üìã **Gest√£o de Matr√≠culas e Estados do Aluno**

#### 1.1 Estados do Aluno
```
PRE_MATRICULA -> MATRICULADO -> ATIVO/INADIMPLENTE/SUSPENSO -> INATIVO
```

- **PR√â-MATR√çCULA**: Aluno cadastrado mas n√£o matriculado efetivamente
- **MATRICULADO**: Matr√≠cula paga, aguardando in√≠cio das aulas
- **ATIVO**: Frequentando e em dia com pagamentos
- **INADIMPLENTE**: Com pend√™ncias financeiras
- **SUSPENSO**: Suspenso por inadimpl√™ncia ou disciplina
- **INATIVO**: Ex-aluno ou transferido

#### 1.2 Processo de Matr√≠cula
```
1. Cadastro inicial (PR√â-MATR√çCULA)
2. Gera√ß√£o de boleto de matr√≠cula
3. Confirma√ß√£o de pagamento ‚Üí MATRICULADO
4. In√≠cio das aulas ‚Üí ATIVO
```

### 2. üí≥ **Sistema de T√≠tulos e Cobran√ßa**

#### 2.1 Estrutura de T√≠tulo Financeiro
```javascript
titulo: {
  id: "string",                    // ID √∫nico
  alunoId: "string",              // Refer√™ncia ao aluno
  tipo: "matricula|mensalidade|taxa", // Tipo do t√≠tulo
  descricao: "string",            // Descri√ß√£o do t√≠tulo
  valorOriginal: "number",        // Valor sem desconto
  valorDesconto: "number",        // Valor do desconto
  valorFinal: "number",           // Valor final a pagar
  dataVencimento: "date",         // Data de vencimento
  dataGeracao: "date",            // Data de gera√ß√£o
  status: "pendente|pago|vencido|cancelado",
  formaPagamento: "boleto|pix|cartao|dinheiro",
  dataComprovante: "date",        // Data do comprovante
  observacoes: "string",
  
  // Controle de cobran√ßa
  tentativasCobranca: "number",
  ultimaCobranca: "date",
  proximaCobranca: "date",
  
  // Auditoria
  criadoPor: "string",
  atualizadoPor: "string",
  createdAt: "date",
  updatedAt: "date"
}
```

#### 2.2 Gera√ß√£o Autom√°tica de T√≠tulos
- **Matr√≠cula**: Gerada no momento do cadastro (PR√â-MATR√çCULA)
- **Mensalidades**: Geradas automaticamente no in√≠cio de cada m√™s
- **Taxas extras**: Material, uniforme, eventos, etc.

#### 2.3 Regras de Gera√ß√£o
```javascript
// Configura√ß√£o por per√≠odo escolar
configuracaoFinanceira: {
  periodoId: "string",
  valorMatricula: "number",
  valorMensalidade: "number",
  diaVencimentoPadrao: "number",
  descontoMatriculaAntecipada: "number",
  jurosAtraso: "number",
  multaAtraso: "number",
  diasParaSuspensao: "number",     // Ex: 30 dias
  diasParaCancelamento: "number"   // Ex: 90 dias
}
```

### 3. üìä **Dashboard Financeiro**

#### 3.1 Indicadores Principais
- **Receita Prevista vs Realizada** (mensal/anual)
- **Taxa de Inadimpl√™ncia** (% alunos com atraso)
- **Previs√£o de Recebimentos** (pr√≥ximos 30/60/90 dias)
- **Alunos por Status Financeiro**
- **M√©dia de Atraso** (dias em atraso)

#### 3.2 Relat√≥rios Financeiros
- **Relat√≥rio de Inadimpl√™ncia**
- **Fluxo de Caixa Projetado**
- **Relat√≥rio de Matr√≠culas** (per√≠odo)
- **An√°lise de Descontos Concedidos**
- **Hist√≥rico de Pagamentos por Aluno**

### 4. üîî **Sistema de Notifica√ß√µes e Cobran√ßa**

#### 4.1 Notifica√ß√µes Autom√°ticas
- **5 dias antes**: Lembrete de vencimento
- **No vencimento**: T√≠tulo vencendo hoje
- **3 dias ap√≥s**: Primeira cobran√ßa
- **15 dias ap√≥s**: Segunda cobran√ßa
- **30 dias ap√≥s**: Aviso de suspens√£o
- **45 dias ap√≥s**: Notifica√ß√£o de cancelamento

#### 4.2 Canais de Comunica√ß√£o
- **WhatsApp Business API**
- **Email autom√°tico**
- **SMS** (opcional)
- **Notifica√ß√£o no app**

### 5. üè¶ **Integra√ß√£o com Sistemas de Pagamento**

#### 5.1 M√©todos de Pagamento
- **PIX**: Gera√ß√£o autom√°tica de QR Code
- **Boleto Banc√°rio**: Integra√ß√£o com bancos
- **Cart√£o de Cr√©dito**: Gateway de pagamento
- **Transfer√™ncia Banc√°ria**
- **Dinheiro**: Registro manual

#### 5.2 Reconcilia√ß√£o Autom√°tica
- **Webhook de confirma√ß√£o** de pagamentos
- **Baixa autom√°tica** de t√≠tulos pagos
- **Controle de diverg√™ncias**
- **Estorno** e cancelamentos

### 6. üì± **Interface do Sistema Financeiro**

#### 6.1 Tela Principal - Dashboard Financeiro
```
‚îå‚îÄ Dashboard Financeiro ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ üí∞ Receita do M√™s    üìä Taxa Inadimpl√™ncia           ‚îÇ
‚îÇ R$ 45.000,00        ‚ö†Ô∏è  8,5%                        ‚îÇ
‚îÇ                                                      ‚îÇ
‚îÇ üìà Pr√≥ximos Vencimentos   üîç Busca R√°pida           ‚îÇ
‚îÇ R$ 12.000,00 (15 t√≠tulos) [____________________]     ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

#### 6.2 Gest√£o de T√≠tulos
```
‚îå‚îÄ T√≠tulos Financeiros ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ Filtros: [Status‚ñº] [Tipo‚ñº] [Per√≠odo‚ñº] [üîç Buscar]   ‚îÇ
‚îÇ                                                      ‚îÇ
‚îÇ ‚îå‚îÄ Jo√£o Silva - S001 ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê  ‚îÇ
‚îÇ ‚îÇ üí≥ Mensalidade Set/2025    üìÖ Venc: 10/09/2025 ‚îÇ  ‚îÇ
‚îÇ ‚îÇ R$ 800,00 ‚Üí R$ 720,00     ‚ö†Ô∏è  VENCIDO (5 dias) ‚îÇ  ‚îÇ
‚îÇ ‚îÇ [üí∞ Registrar Pagto] [üìß Cobrar] [üëÅÔ∏è Detalhes] ‚îÇ  ‚îÇ
‚îÇ ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò  ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

#### 6.3 Cadastro de Matr√≠cula
```
‚îå‚îÄ Nova Matr√≠cula ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ 1Ô∏è‚É£ Dados do Aluno                                   ‚îÇ
‚îÇ 2Ô∏è‚É£ Configura√ß√£o Financeira                         ‚îÇ
‚îÇ 3Ô∏è‚É£ Gera√ß√£o de T√≠tulo de Matr√≠cula                  ‚îÇ
‚îÇ                                                      ‚îÇ
‚îÇ Status: PR√â-MATR√çCULA ‚Üí MATRICULADO                 ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

### 7. üîí **Seguran√ßa e Auditoria Financeira**

#### 7.1 Controles de Acesso
- **Coordenadora**: Acesso total ao financeiro
- **Secret√°ria Financeira**: Gest√£o de t√≠tulos e pagamentos
- **Professora**: Consulta limitada de status dos alunos
- **Pai/Respons√°vel**: Apenas seus pr√≥prios t√≠tulos

#### 7.2 Auditoria Obrigat√≥ria
- **Log de todas as opera√ß√µes** financeiras
- **Hist√≥rico de altera√ß√µes** em valores
- **Trilha de aprova√ß√µes** para descontos
- **Backup de comprovantes** de pagamento

### 8. üìã **Implementa√ß√£o - Fases**

#### Fase 1: Infraestrutura (2-3 semanas)
- [ ] Criar estrutura de dados para t√≠tulos
- [ ] Implementar estados do aluno
- [ ] Sistema b√°sico de gera√ß√£o de t√≠tulos
- [ ] Interface de gest√£o de t√≠tulos

#### Fase 2: Automa√ß√£o (2-3 semanas)
- [ ] Gera√ß√£o autom√°tica de mensalidades
- [ ] Sistema de notifica√ß√µes
- [ ] Dashboard financeiro
- [ ] Relat√≥rios b√°sicos

#### Fase 3: Integra√ß√£o (3-4 semanas)
- [ ] Integra√ß√£o PIX/Boletos
- [ ] Reconcilia√ß√£o autom√°tica
- [ ] WhatsApp Business
- [ ] Relat√≥rios avan√ßados

#### Fase 4: Otimiza√ß√£o (1-2 semanas)
- [ ] Interface mobile responsiva
- [ ] Performance e escalabilidade
- [ ] Testes de stress
- [ ] Documenta√ß√£o completa

### 9. üéØ **Crit√©rios de Aceite**

#### Funcionais
- ‚úÖ Aluno n√£o pode ser ativado sem pagar matr√≠cula
- ‚úÖ Mensalidades s√£o geradas automaticamente
- ‚úÖ Notifica√ß√µes s√£o enviadas conforme cronograma
- ‚úÖ Pagamentos s√£o baixados automaticamente
- ‚úÖ Relat√≥rios s√£o gerados em tempo real
- ‚úÖ Hist√≥rico financeiro √© preservado

#### T√©cnicos
- ‚úÖ Transa√ß√µes s√£o at√¥micas e consistentes
- ‚úÖ Dados financeiros s√£o criptografados
- ‚úÖ Backup autom√°tico di√°rio
- ‚úÖ Logs de auditoria completos
- ‚úÖ Performance < 2s para consultas
- ‚úÖ Disponibilidade > 99,5%

#### Seguran√ßa
- ‚úÖ Acesso por roles bem definidos
- ‚úÖ Dados sens√≠veis mascarados
- ‚úÖ Conformidade LGPD
- ‚úÖ Certificado SSL v√°lido
- ‚úÖ Autentica√ß√£o multifator (opcional)

---

## üí° **Observa√ß√µes Importantes**

### Impacto na Arquitetura Atual
- **Nova collection**: `titulos_financeiros`
- **Evolu√ß√£o**: Estrutura atual do `aluno.financeiro`
- **Adi√ß√£o**: Estados do aluno mais robustos
- **Integra√ß√£o**: APIs externas de pagamento

### Depend√™ncias Externas
- **WhatsApp Business API** (R$ 0,05 por mensagem)
- **Gateway de Pagamento** (2-4% por transa√ß√£o)
- **Banco para Boletos** (R$ 0,30-0,80 por boleto)
- **Certificado SSL** (se n√£o houver)

### ROI Estimado
- **Redu√ß√£o de inadimpl√™ncia**: 15-25%
- **Tempo de cobran√ßa manual**: -80%
- **Satisfa√ß√£o dos pais**: +30%
- **Tempo de reconcilia√ß√£o**: -90%

---

> **üìå Este sistema financeiro transformar√° a gest√£o escolar, automatizando processos manuais e melhorando significativamente o controle financeiro da institui√ß√£o.**

---

> Para gerar o PDF: abra este arquivo no VS Code, clique com o bot√£o direito e escolha "Export as PDF" ou use a op√ß√£o de imprimir para PDF.
